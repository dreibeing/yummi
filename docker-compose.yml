version: '3.9'
services:
  yummi-server:
    build:
      context: .
      dockerfile: yummi-server/Dockerfile
    image: yummi-server:dev
    environment:
      - ENVIRONMENT=dev
      - APP_NAME=yummi-server
      - LOG_JSON=true
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - CLERK_ISSUER=${CLERK_ISSUER}
      - CLERK_JWKS_URL=${CLERK_JWKS_URL}
      - CLERK_AUDIENCE=${CLERK_AUDIENCE}
      - AUTH_DISABLE_VERIFICATION=${AUTH_DISABLE_VERIFICATION:-true}
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/yummi
      - REDIS_URL=redis://redis:6379/0
      - CATALOG_PATH=resolver/catalog.json
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-["*"]}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_ALLOWED_MODELS=${OPENAI_ALLOWED_MODELS:-["gpt-4o-mini","gpt-4o","o4-mini"]}
      - OPENAI_DEFAULT_MODEL=${OPENAI_DEFAULT_MODEL:-gpt-4o-mini}
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_TRACES_SAMPLE_RATE=${SENTRY_TRACES_SAMPLE_RATE:-0}
      - PAYFAST_MERCHANT_ID=${PAYFAST_MERCHANT_ID:-}
      - PAYFAST_MERCHANT_KEY=${PAYFAST_MERCHANT_KEY:-}
      - PAYFAST_PASSPHRASE=${PAYFAST_PASSPHRASE:-}
      - PAYFAST_NOTIFY_URL=${PAYFAST_NOTIFY_URL:-http://host.docker.internal:8000/payments/payfast/itn}
      - PAYFAST_RETURN_URL=${PAYFAST_RETURN_URL:-http://localhost:19006/payfast/return}
      - PAYFAST_CANCEL_URL=${PAYFAST_CANCEL_URL:-http://localhost:19006/payfast/cancel}
      - PAYFAST_MODE=${PAYFAST_MODE:-sandbox}
      - PAYFAST_PDT_TOKEN=${PAYFAST_PDT_TOKEN:-}
    ports:
      - "8000:8000"
    depends_on:
      - db
      - redis
    volumes:
      - ./resolver:/app/resolver:ro

  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=yummi
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

volumes:
  pgdata:
